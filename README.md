# Github Actions with Terraform on AWS

## Description
`qa.yml` and `prod.yml` are GitHub Actions workflows for Terraform and AWS.


`qa.yml` is triggered by a commit to a branch different than main/master (`on` section).
It's a good solution for testing purposes.


`prod.yml` is triggered by a Pull Request to the main/master branch (`on` section).
Use it for production deployments.


There are two jobs:

* plan

* apply


The idea is to review the `plan` job (Actions section) once completed. Then there are two options: 

* `Reject` which stops the workflow

* `Approve and deploy` which triggers `apply` job


There are two GitHub Actions keys used in the workflows:

* `environment` - used for environment secrets, pauses the workflow and requests a job `plan` review before moving to the next job `apply`

* `artifacts` - used to pass a file generated by a terraform plan, from `plan` job to `apply` job


## Prerequisites
1. Create environments in your GitHub repository settings for: `QA`, `QA-apply`, `PROD`, and `PROD-apply`. 
2. Enable manual approval gate for `QA-apply` and `PROD-apply`: 
   
    * Go to: Settings -> Environments -> New Environment -> QA-apply/PROD-apply -> Check and add Required reviewers -> Add Environment Secrets -> Click on Save protection rules

3. Specify a working directory in your repository for Terraform files (`working-directory` key)

4. Set environmental variables for AWS (`env` key):
   
    * AWS_ACCESS_KEY_ID - access key id
    * AWS_SECRET_ACCESS_KEY - secret access key
    * AWS_BUCKET - S3 bucket
    * AWS_BUCKET_KEY - S3 bucket key (file)
    * AWS_REGION - region
    * AWS_DYNAMODB_TABLE - dynamodbtable

5. Setup permissions for accessing AWS resources. This can be done either by:

.creating an AWS access key, configuring it as a secret for the repo, and then using it in your pipeline environment, which is the example setup that is used in      qa.yml and prod.yml pipelines:
AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
or establishing OIDC trust between AWS and GitHub, example of which can be found in oidc_setup folder:
first create an OIDC provider and role that will be used by GitHub, by deploying the cfn-oidc-github-trust.yaml template. You should update the role policy depending on your requirements
then you can create your GitHub workflow, in which you should include the aws-actions/configure-aws-credentials action, which first obtains a JWT from GitHub, which is then exchanged for AWS credentials using STS

6. Check retention period for artifacts (retention-days key). By default, it is 90 days.
